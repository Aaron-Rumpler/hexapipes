<script context="module">
  export async function load({ params, fetch }) {
    const size = `${params.size}x${params.size}`
    const id = Number(params.id)
    const folderNum = Math.floor((id-1)/100)
    const url = `/_instances/hexagonal/${size}/${folderNum}/${id}.json`;
    const response = await fetch(url);

    if (response.ok) {
      const data = await response.json()
      return {
        status: response.status,
        props: {
          width: data.width,
          height: data.height,
          tiles: data.tiles,
        }
      }
    } else {
      return {
      status: response.status,
    };
    }
  }
</script>

<script>
  import { page } from '$app/stores';
  import { browser } from '$app/env';
  import { goto } from '$app/navigation';
  import Puzzle from '$lib/puzzle/Puzzle.svelte';
  import Timer from '$lib/Timer.svelte';
  import Stats from '$lib/Stats.svelte';
  import PuzzleButtons from '$lib/PuzzleButtons.svelte';
  import {getSolves, getStats, puzzleCounts} from '$lib/stores';

  export let width
  export let height
  export let tiles
  let solved = false
  let nextPuzzleId = 1
  let previousParams = {
    size: "0",
    id: "0",
  }

  let solves // a store of puzzles solve times
  let stats // a store of puzzle time stats

  let progressStoreName = ''
  let savedProgress

  $: progressStoreName = $page.url.pathname + '_progress'

  let solve = {
        puzzleId: -1,
        startedAt: -1,
        finishedAt: -1,
        elapsedTime: -1,
    }
  /** @type {import('$lib/puzzle/Puzzle.svelte').default}*/
  let puzzle


  $: if (browser && $page.params) {
    if ($page.params.size !== previousParams.size) {
      // if a player used the back button 
      // and went from puzzle of one size
      // directly to a puzzle of another size
      // then we need to update solves and stats
      solves = getSolves($page.url.pathname)
      stats = getStats($page.url.pathname)
      start()
    } else if ($page.params.id !== previousParams.id) {
      start()
    }
    solved = false
    const progress = window.localStorage.getItem(progressStoreName)
    if (progress !== null) {
      savedProgress = JSON.parse(progress)
    } else {
      savedProgress = undefined
    }
  }

  function start() {
    previousParams.size = $page.params.size
    previousParams.id = $page.params.id
    if (solves!==undefined) {
      solve = solves.reportStart(Number($page.params.id))
    }
    nextPuzzleId = solves.choosePuzzleId(
      $puzzleCounts.hexagonal[`${$page.params.size}x${$page.params.size}`], 
      Number($page.params.id)
    )
  }

  function stop() {
    solved = true
    solve = solves.reportFinish(Number($page.params.id))
    window.localStorage.removeItem(progressStoreName)
  }

  function saveProgress(event) {
    const {data, name} = event.detail
    const dataStr = JSON.stringify(data)
    window.localStorage.setItem(name, dataStr)
  }

  function startOver() {
    solved = false
    puzzle.startOver()
  }

  function newPuzzle() {
    goto(`/hexagonal/${$page.params.size}/${nextPuzzleId}`)
  }
</script>

<svelte:head>
  <title>
    {$page.params.size}x{$page.params.size} Hexagonal Pipes Puzzle #{$page.params.id}
  </title>
</svelte:head>


<div class="info container">
  <h2> {$page.params.size}x{$page.params.size} Hexagonal Pipes Puzzle #{$page.params.id}</h2>
  
  <p>Rotate the tiles so that all pipes are connected with no loops.</p>
</div>

{#key $page.params}
  <Puzzle {width} {height} {tiles} {savedProgress}
     {progressStoreName}
     bind:this={puzzle}
     on:solved={stop}
     on:initialized={start}
     on:progress={saveProgress}
  />
{/key}

<div class="container">
  <div class="congrat"> 
    {#if solve.elapsedTime !== -1}
      {#if solved}
        Solved! 
      {/if}
      <a href="/hexagonal/{$page.params.size}/{nextPuzzleId}">Next puzzle</a> 
    {/if}
  </div>
  <PuzzleButtons
    solved={solve.elapsedTime !== -1}
    on:startOver={startOver}  
    on:newPuzzle={newPuzzle}  
  />
</div>

<div class="timings">
  <Timer {solve}/>
</div>
{#if stats}
  <div class="stats">
    <Stats {stats}/>
  </div>
{/if}

<style>
.congrat {
    margin: auto;
    margin-bottom: 20px;
    font-size: 150%;
    color: var(--primary-color);
    text-align: center;
    min-height: 30px;
}
.info {
  text-align: center;
}
</style>